<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Chat ao vivasso</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <form id="chat">
        <span>Usuários ativos:</span>
        <ul class="users">
            <!--  -->
        </ul>
        <div class="messages"></div>
        <input type="text" name="message" placeholder="digite a sua mensagem">
        <button type="submit">Enviar</button>
    </form>
    <script type="text/javascript">
        
        var contract = prompt('insira o contrato', '123');
        var username = prompt('insira o nome de usuário', 'teste');
        var id = prompt('insira o id de usuário', '321');

        const ActiveUser = {
            id: id,
            name: username,
            contract: contract
        };

        var socket = io.connect('http://localhost:3000', { 
            query: `id=${ActiveUser.id}&name=${ActiveUser.name}&contract=${ActiveUser.contract}` 
        });

        function renderMessage(message) {
            let messageObject = parseObject(message);
            $('.messages').append(`
                <div class="message">
                    <strong>${messageObject.author.name}</strong>:${messageObject.message}
                </div>`
            );
        }
        
        function renderActiveUser(user) {
            let userObject = parseObject(user);
            console.log(userObject);
            
            $('.users').append(`
                <li id="user-${userObject.id}" class="user" data-id="${userObject.id}">
                    ${userObject.name}
                </li>`);
        }

        function renderDisconectedUser(user) {
            let userObject = parseObject(user);
            $(`#user-${userObject.id}`).remove();
        }

        function mayHandleUser(user, event) {

            let userObject = parseObject(user);

            let userElement = $(`#user-${userObject.id}`);

            console.log(userElement);

            switch (event) {
                case 'connect':
                    
                    if (
                        ActiveUser.contract == userObject.contract && 
                        (userElement.length == 0|| userElement.data('id') != ActiveUser.id)  
                    ) return true;
                    break;
                case 'disconnect':
                    if (
                        ActiveUser.contract == userObject.contract && 
                        userElement.is("li")
                    ) return true;    
                    break;
            }
            return false;
        }

        function parseObject(object){
            return (typeof object === 'string') ? JSON.parse(object) : object;
        }

        socket.on('previousConnectedUsers', function(users){
           
            for (user of users) {
                renderActiveUser(user);
            }
        });

        socket.on('userConnected', function(user){
            if (mayHandleUser(user, 'connect')) {
                renderActiveUser(user);
            }
        });

        socket.on('userDisconnected', function(user){
            console.log('usuario desconectado');
            renderDisconectedUser(user);
        });
        
        socket.on('previousMessages', function(messages){
            for (message of messages) {
                renderMessage(message);
            }
        });

        socket.on('receivedMessage', function(message){
            renderMessage(message);
        });
        
        $("#chat").submit(function(event) {
            event.preventDefault(); 
        
            var message = $("input[name=message]").val();

            $("input[name=message]").val('');

            if (message.length) {

                var messageObject = {
                    author: ActiveUser,
                    message: message,
                };

                socket.emit('sendMessage', messageObject);
                renderMessage(messageObject);
            }
        });
    </script>
</body>
</html>